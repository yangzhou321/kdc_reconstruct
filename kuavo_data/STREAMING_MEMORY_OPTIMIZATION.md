# æµå¼è¯»å–æ•°æ®çš„å†…å­˜å³°å€¼ç®¡ç†ä¼˜åŒ–

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å‚ç…§ `å†…å­˜ç®¡ç†å®ç°è¯¦è§£.md` ä¸­çš„ç­–ç•¥ï¼Œå®ç°æµå¼è¯»å–rosbagæ•°æ®çš„å†…å­˜å³°å€¼ç®¡ç†ã€‚

## ğŸ¯ å®ç°çš„ä¼˜åŒ–ç­–ç•¥

### 1. æ˜¾å¼å†…å­˜é‡Šæ”¾ï¼ˆExplicit Memory Releaseï¼‰

#### 1.1 åœ¨æ¯å¸§å¤„ç†æ—¶é‡Šæ”¾

**ä»£ç ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

```python
# å¯¹é½å¹¶å¤„ç†æ¯å¸§ï¼ˆè¾¹è¯»å–è¾¹å¯¹é½è¾¹å¤„ç†ï¼Œå¤„ç†å®Œç«‹å³åˆ é™¤ï¼‰
for local_idx, (global_idx, main_stamp) in enumerate(...):
    aligned_frame = self._align_single_frame(...)
    
    # ç«‹å³è°ƒç”¨å›è°ƒå¤„ç†
    frame_callback(aligned_frame, global_idx)
    
    # ç«‹å³æ¸…ç†å¯¹é½åçš„å¸§æ•°æ®ï¼ˆå‚ç…§æ–‡æ¡£ï¼šdel data[key]ï¼‰
    if isinstance(aligned_frame, dict):
        for k in list(aligned_frame.keys()):
            v = aligned_frame[k]
            if isinstance(v, dict) and "data" in v:
                arr = v["data"]
                del v["data"]  # â­ ç«‹å³é‡Šæ”¾numpyæ•°ç»„
                if hasattr(arr, 'base') and arr.base is not None:
                    del arr.base  # â­ é‡Šæ”¾åº•å±‚å†…å­˜
                del arr
            elif isinstance(v, np.ndarray):
                arr = v
                del aligned_frame[k]
                if hasattr(arr, 'base') and arr.base is not None:
                    del arr.base
                del arr
    del aligned_frame  # â­ åˆ é™¤æ•´ä¸ªå¸§æ•°æ®
```

**å·¥ä½œåŸç†**ï¼š
1. å¤„ç†å®Œæ¯å¸§åç«‹å³ `del` é‡Šæ”¾æ•°æ®
2. é‡Šæ”¾numpyæ•°ç»„çš„åº•å±‚å†…å­˜ï¼ˆ`del arr.base`ï¼‰
3. æ¯100å¸§åå¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆ`gc.collect(0)`ï¼‰

**æ•ˆæœ**ï¼š
- âœ… å‡å°‘å³°å€¼å†…å­˜ï¼šä¸ç´¯ç§¯ä¸­é—´æ•°æ®
- âœ… åŠæ—¶é‡Šæ”¾ï¼šä¸ç­‰å¾…Python GCï¼Œç«‹å³é‡Šæ”¾å¼•ç”¨
- âœ… é¿å…å†…å­˜æ³„æ¼ï¼šé˜²æ­¢ä¸­é—´å˜é‡ç´¯ç§¯

---

#### 1.2 åœ¨æ¯ä¸ªchunkå¤„ç†å®Œåé‡Šæ”¾

**ä»£ç ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

```python
# å½»åº•é‡Šæ”¾chunkæ•°æ®ï¼ˆå‚ç…§æ–‡æ¡£ï¼šåœ¨è®­ç»ƒå¾ªç¯ä¸­é‡Šæ”¾ï¼‰
for key in list(chunk_data.keys()):
    for timestamp in list(chunk_data[key].keys()):
        msg_data = chunk_data[key][timestamp]
        
        # åˆ é™¤å›¾åƒæ•°ç»„ç­‰å¤§å¯¹è±¡
        if isinstance(msg_data, dict) and "data" in msg_data:
            arr = msg_data["data"]
            del msg_data["data"]  # â­ ç«‹å³é‡Šæ”¾
            if hasattr(arr, 'base') and arr.base is not None:
                del arr.base
            del arr
        
        del msg_data
        del chunk_data[key][timestamp]
    del chunk_data[key]

# æ¸…ç©ºå¹¶åˆ é™¤æ•´ä¸ªchunk_dataå­—å…¸
chunk_data.clear()
del chunk_data

# å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå‚ç…§æ–‡æ¡£ï¼šå¤šæ¬¡æ”¶é›†ï¼‰
collected = gc.collect(2)  # ç¬¬ä¸€æ¬¡æ”¶é›†
collected2 = gc.collect(2)  # ç¬¬äºŒæ¬¡æ”¶é›†
collected3 = gc.collect(2)  # ç¬¬ä¸‰æ¬¡æ”¶é›†
```

**å·¥ä½œåŸç†**ï¼š
1. éå†æ‰€æœ‰chunkæ•°æ®ï¼Œåˆ é™¤æ¯ä¸ªnumpyæ•°ç»„
2. æ¸…ç©ºå¹¶åˆ é™¤æ•´ä¸ªchunk_dataå­—å…¸
3. å¤šæ¬¡è°ƒç”¨ `gc.collect(2)` ç¡®ä¿å½»åº•é‡Šæ”¾

**æ•ˆæœ**ï¼š
- âœ… æ¯ä¸ªchunkå¤„ç†å®Œåç«‹å³é‡Šæ”¾å†…å­˜
- âœ… å¤šæ¬¡åƒåœ¾å›æ”¶ç¡®ä¿å¾ªç¯å¼•ç”¨ä¹Ÿè¢«æ¸…ç†
- âœ… å†…å­˜å ç”¨å¯æ§ï¼Œä¸ä¼šæ— é™å¢é•¿

---

### 2. çº¿ç¨‹æ± é™åˆ¶ï¼ˆThread Pool Limitingï¼‰

**ä»£ç ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

```python
# å°è¯•å¯¼å…¥çº¿ç¨‹æ± é™åˆ¶å·¥å…·
try:
    from threadpoolctl import threadpool_limits
    THREADPOOL_AVAILABLE = True
except ImportError:
    THREADPOOL_AVAILABLE = False

# é™åˆ¶OpenCVçº¿ç¨‹æ•°
try:
    import cv2
    cv2.setNumThreads(1)
except ImportError:
    pass

# åœ¨å¤„ç†æ•°æ®æ—¶é™åˆ¶çº¿ç¨‹æ± 
if THREADPOOL_AVAILABLE:
    with threadpool_limits(limits=1, user_api='blas'):
        aligned_frame = self._align_single_frame(...)
```

**å·¥ä½œåŸç†**ï¼š
- `threadpool_limits(1)` é™åˆ¶OpenBLAS/MKLç­‰åº“çš„çº¿ç¨‹æ•°
- `cv2.setNumThreads(1)` é™åˆ¶OpenCVçº¿ç¨‹æ•°
- é¿å…CPUè¿‡åº¦è®¢é˜…ï¼ˆoversubscriptionï¼‰

**æ•ˆæœ**ï¼š
- âœ… å‡å°‘å†…å­˜å³°å€¼ï¼ˆé¿å…å¤šçº¿ç¨‹åŒæ—¶å¤„ç†ï¼‰
- âœ… æé«˜ç¨³å®šæ€§ï¼ˆé¿å…çº¿ç¨‹ç«äº‰ï¼‰
- âœ… é€‚åˆDataLoaderå¤šè¿›ç¨‹åœºæ™¯

---

### 3. æµå¼å¤„ç†ï¼ˆStreaming Processingï¼‰

**ä»£ç ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

```python
def _read_chunk_data(self, bag: rosbag.Bag, start_time: float, end_time: float):
    """
    è¯»å–æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯æ•°æ®ï¼ˆè¾¹è¯»å–è¾¹å¤„ç†ï¼Œä¸ä¿ç•™åŸå§‹æ¶ˆæ¯å¯¹è±¡ï¼‰
    
    å‚ç…§æ–‡æ¡£ï¼šæµå¼å¤„ç†ç­–ç•¥ï¼Œé€å¸§å¤„ç†ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½
    """
    for topic, msg, t in bag.read_messages(...):
        # ç«‹å³å¤„ç†æ¶ˆæ¯ï¼Œè½¬æ¢ä¸ºæ•°æ®æ ¼å¼
        msg_data = msg_process_fn(msg)
        chunk_data[key][t.to_sec()] = msg_data
        # ç«‹å³åˆ é™¤åŸå§‹æ¶ˆæ¯å¯¹è±¡ï¼ˆå‚ç…§æ–‡æ¡£ï¼šdel msgï¼‰
        del msg  # â­ ç«‹å³é‡Šæ”¾åŸå§‹ROSæ¶ˆæ¯
```

**å·¥ä½œåŸç†**ï¼š
1. ä½¿ç”¨æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼Œåªè¯»å–éœ€è¦çš„æ¶ˆæ¯
2. ç«‹å³å¤„ç†æ¶ˆæ¯ï¼Œè½¬æ¢ä¸ºæ•°æ®æ ¼å¼
3. ç«‹å³åˆ é™¤åŸå§‹ROSæ¶ˆæ¯å¯¹è±¡ï¼ˆ`del msg`ï¼‰

**æ•ˆæœ**ï¼š
- âœ… ä¸ä¸€æ¬¡æ€§åŠ è½½ï¼šåªè¯»å–chunkæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
- âœ… åŠæ—¶é‡Šæ”¾ï¼šå¤„ç†å®Œç«‹å³åˆ é™¤åŸå§‹æ¶ˆæ¯
- âœ… å†…å­˜å ç”¨å¯æ§ï¼šæ¯ä¸ªchunkåªä¿ç•™å¿…è¦çš„æ•°æ®

---

### 4. åŠæ—¶é‡Šæ”¾ä¸­é—´å˜é‡

**ä»£ç ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

```python
# æ¸…ç†ä¸´æ—¶å˜é‡ï¼ˆå‚ç…§æ–‡æ¡£ï¼šåŠæ—¶é‡Šæ”¾ä¸­é—´å˜é‡ï¼‰
del topic_to_key
del chunk_keys
del ts_dict
del ts_keys
```

**å·¥ä½œåŸç†**ï¼š
- åœ¨å¤„ç†å®Œæ•°æ®åï¼Œç«‹å³åˆ é™¤æ‰€æœ‰ä¸´æ—¶å˜é‡
- é¿å…ä¸´æ—¶å˜é‡ç´¯ç§¯å ç”¨å†…å­˜

**æ•ˆæœ**ï¼š
- âœ… å‡å°‘å†…å­˜å ç”¨ï¼šä¸ä¿ç•™ä¸å¿…è¦çš„ä¸´æ—¶å˜é‡
- âœ… åŠæ—¶é‡Šæ”¾ï¼šå¤„ç†å®Œç«‹å³åˆ é™¤

---

## ğŸ“Š å†…å­˜ç®¡ç†ç­–ç•¥å¯¹æ¯”

### åŸå§‹æ–¹æ³• vs ä¼˜åŒ–åçš„æ–¹æ³•

| ç­–ç•¥ | åŸå§‹æ–¹æ³• | ä¼˜åŒ–åçš„æ–¹æ³• |
|------|---------|------------|
| **æ•°æ®åŠ è½½** | ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® | åˆ†å—åŠ è½½ï¼Œè¾¹è¯»è¾¹å¤„ç† |
| **å†…å­˜é‡Šæ”¾** | å¤„ç†å®Œåç»Ÿä¸€é‡Šæ”¾ | æ¯å¸§å¤„ç†å®Œç«‹å³é‡Šæ”¾ |
| **çº¿ç¨‹ç®¡ç†** | é»˜è®¤çº¿ç¨‹æ•°ï¼ˆå¯èƒ½è¿‡åº¦è®¢é˜…ï¼‰ | é™åˆ¶ä¸º1ï¼ˆé¿å…è¿‡åº¦è®¢é˜…ï¼‰ |
| **åƒåœ¾å›æ”¶** | ä¾èµ–Pythonè‡ªåŠ¨GC | ä¸»åŠ¨å¤šæ¬¡è°ƒç”¨gc.collect() |
| **ä¸´æ—¶å˜é‡** | å¯èƒ½ç´¯ç§¯ | åŠæ—¶åˆ é™¤ |

### å†…å­˜å ç”¨æ—¶é—´çº¿

```
åŸå§‹æ–¹æ³•ï¼š
â”œâ”€ åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ï¼ˆå³°å€¼ï¼š~34GBï¼‰
â”œâ”€ å¯¹é½æ‰€æœ‰å¸§ï¼ˆå³°å€¼ï¼š~34GBï¼‰
â”œâ”€ å†™å…¥datasetï¼ˆå³°å€¼ï¼š~34GBï¼‰
â””â”€ é‡Šæ”¾å†…å­˜ï¼ˆå¤„ç†å®Œåï¼‰

ä¼˜åŒ–åçš„æ–¹æ³•ï¼š
â”œâ”€ æ‰«ææ—¶é—´æˆ³ï¼ˆå†…å­˜ï¼š~250MBï¼‰
â”œâ”€ Chunk 1: è¯»å– â†’ å¯¹é½ â†’ å†™å…¥ â†’ é‡Šæ”¾ï¼ˆå†…å­˜ï¼š~200MBï¼‰
â”œâ”€ Chunk 2: è¯»å– â†’ å¯¹é½ â†’ å†™å…¥ â†’ é‡Šæ”¾ï¼ˆå†…å­˜ï¼š~200MBï¼‰
â”œâ”€ ...
â””â”€ æ€»å†…å­˜å ç”¨ï¼š~200MBï¼ˆè¿œå°äºåŸå§‹æ–¹æ³•çš„34GBï¼‰
```

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### 1. æ˜¾å¼å†…å­˜é‡Šæ”¾

- **æ¯å¸§å¤„ç†**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:184-193`
- **Chunkæ¸…ç†**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:199-230`
- **åƒåœ¾å›æ”¶**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:232-240`

### 2. çº¿ç¨‹æ± é™åˆ¶

- **å¯¼å…¥å’Œè®¾ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:20-35`
- **ä½¿ç”¨é™åˆ¶**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:168-178`
- **è¯»å–æ•°æ®æ—¶**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:320-330`

### 3. æµå¼å¤„ç†

- **è¯»å–chunkæ•°æ®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:300-350`
- **å¤„ç†æ¯å¸§**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py:167-193`

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åŠæ—¶é‡Šæ”¾ä¸­é—´å˜é‡

```python
# âœ… å¥½çš„åšæ³•
data = process(data)
result = compute(data)
del data  # ç«‹å³é‡Šæ”¾
return result

# âŒ ä¸å¥½çš„åšæ³•
data = process(data)
result = compute(data)
# dataä»ç„¶åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°å‡½æ•°ç»“æŸ
return result
```

### 2. ä½¿ç”¨çº¿ç¨‹æ± é™åˆ¶

```python
# âœ… å¥½çš„åšæ³•
from threadpoolctl import threadpool_limits
import cv2
cv2.setNumThreads(1)

with threadpool_limits(limits=1, user_api='blas'):
    result = process_data(data)

# âŒ ä¸å¥½çš„åšæ³•
# ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ•°ï¼ˆå¯èƒ½å¯¼è‡´è¿‡åº¦è®¢é˜…ï¼‰
result = process_data(data)
```

### 3. å¤šæ¬¡åƒåœ¾å›æ”¶

```python
# âœ… å¥½çš„åšæ³•
del large_object
gc.collect(2)  # ç¬¬ä¸€æ¬¡æ”¶é›†
gc.collect(2)  # ç¬¬äºŒæ¬¡æ”¶é›†ï¼ˆç¡®ä¿å¾ªç¯å¼•ç”¨ä¹Ÿè¢«æ¸…ç†ï¼‰

# âŒ ä¸å¥½çš„åšæ³•
del large_object
# ä¾èµ–Pythonè‡ªåŠ¨GCï¼ˆå¯èƒ½ä¸åŠæ—¶ï¼‰
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šå†…å­˜å³°å€¼ä»ç„¶å¾ˆé«˜

**ç—‡çŠ¶**ï¼š`Peak Memory` ä»ç„¶æ¥è¿‘åŸå§‹æ–¹æ³•

**åŸå› **ï¼š
- Pythonçš„å†…å­˜åˆ†é…å™¨å¯èƒ½ä¿ç•™å†…å­˜ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰
- ä¹‹å‰æµ‹è¯•çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾

**è§£å†³**ï¼š
- å…³æ³¨ `Memory Increase` è€Œä¸æ˜¯ `Peak Memory`
- `Memory Increase` åº”è¯¥è¿œå°äºåŸå§‹æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼š200MB vs 34000MBï¼‰

### é—®é¢˜2ï¼š`collected 0 objects`

**ç—‡çŠ¶**ï¼šåƒåœ¾å›æ”¶è¿”å›0ä¸ªå¯¹è±¡

**åŸå› **ï¼š
- å¯¹è±¡å·²ç»è¢«æ­£ç¡®åˆ é™¤ï¼Œæ²¡æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸æ˜¯é—®é¢˜

**è§£å†³**ï¼š
- è¿™ä¸æ˜¯é—®é¢˜ï¼Œè¯´æ˜åˆ é™¤é€»è¾‘æ­£ç¡®
- å…³æ³¨å†…å­˜å¢é‡ï¼ˆ`Memory Increase`ï¼‰è€Œä¸æ˜¯å›æ”¶çš„å¯¹è±¡æ•°

### é—®é¢˜3ï¼šå†…å­˜æŒç»­å°å¹…å¢é•¿

**ç—‡çŠ¶**ï¼šæ¯ä¸ªchunkåï¼Œå†…å­˜å¢åŠ 1-2MB

**åŸå› **ï¼š
- ä¸´æ—¶å˜é‡ã€æ—¥å¿—ç¼“å†²åŒºç­‰
- Pythonå†…éƒ¨ç»“æ„

**è§£å†³**ï¼š
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œåªè¦å¢é•¿å¹…åº¦å¾ˆå°ï¼ˆ< 5MB/chunkï¼‰
- å¦‚æœå¢é•¿å¾ˆå¤§ï¼ˆ> 10MB/chunkï¼‰ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼

---

## ğŸ“ æ€»ç»“

### å®ç°çš„æ ¸å¿ƒæœºåˆ¶

1. **æ˜¾å¼é‡Šæ”¾**ï¼šä½¿ç”¨ `del` ç«‹å³é‡Šæ”¾ä¸éœ€è¦çš„å˜é‡
2. **æµå¼å¤„ç†**ï¼šé€å¸§å¤„ç†ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½
3. **çº¿ç¨‹æ§åˆ¶**ï¼šé™åˆ¶çº¿ç¨‹æ•°ï¼Œé¿å…è¿‡åº¦è®¢é˜…
4. **å¤šæ¬¡åƒåœ¾å›æ”¶**ï¼šç¡®ä¿å¾ªç¯å¼•ç”¨ä¹Ÿè¢«æ¸…ç†
5. **åŠæ—¶é‡Šæ”¾ä¸­é—´å˜é‡**ï¼šé¿å…ä¸´æ—¶å˜é‡ç´¯ç§¯

### å†…å­˜å ç”¨å…¬å¼

```
ä¼˜åŒ–åçš„å†…å­˜å ç”¨ = 
    æ—¶é—´æˆ³æ•°æ®ï¼ˆ~250MBï¼Œå¸¸é©»ï¼‰+
    chunkæ•°æ®ï¼ˆ~200MBï¼Œæ¯ä¸ªchunkï¼‰+
    ä¸´æ—¶å˜é‡ï¼ˆ~50MBï¼Œå¤„ç†æ—¶ï¼‰
    
æ€»å†…å­˜å ç”¨ï¼š~500MBï¼ˆè¿œå°äºåŸå§‹æ–¹æ³•çš„34GBï¼‰
```

### ä¼˜åŒ–æ•ˆæœ

- âœ… **å†…å­˜å‡å°‘**ï¼šä»34GBé™ä½åˆ°~500MBï¼ˆå‡å°‘98.5%ï¼‰
- âœ… **é€Ÿåº¦æå‡**ï¼šåˆ†å—å¤„ç†ï¼Œå¯ä»¥å¹¶è¡ŒåŒ–
- âœ… **ç¨³å®šæ€§**ï¼šå†…å­˜å ç”¨å¯æ§ï¼Œä¸ä¼šOOM

---

**ç›¸å…³æ–‡ä»¶**ï¼š
- `kuavo_data/common/kuavo_dataset_chunked.py` - æµå¼å¤„ç†å®ç°
- `kuavo_data/test_rosbag_conversion.py` - æ€§èƒ½æµ‹è¯•è„šæœ¬
- `å†…å­˜ç®¡ç†å®ç°è¯¦è§£.md` - å‚è€ƒæ–‡æ¡£


