# Streaming Method vs Chunked Streaming Method å¯¹æ¯”è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

é¡¹ç›®ä¸­æœ‰ä¸¤ç§æµå¼å¤„ç†æ–¹æ³•ï¼Œå®ƒä»¬çš„å®ç°æ–¹å¼å’Œå†…å­˜å ç”¨æœ‰æ˜¾è‘—åŒºåˆ«ã€‚

## ğŸ” ä¸¤ç§æ–¹æ³•å¯¹æ¯”

### 1. Streaming Method (`process_rosbag_streaming`)

**å®ç°ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_streaming.py`

**å·¥ä½œæµç¨‹**ï¼š
```
ç¬¬ä¸€éæ‰«æï¼š
â”œâ”€ åªè¯»å–æ—¶é—´æˆ³ï¼ˆä¸åŠ è½½å›¾åƒæ•°æ®ï¼‰
â””â”€ ç¡®å®šä¸»æ—¶é—´çº¿å’Œæ—¶é—´æˆ³åºåˆ—
   å†…å­˜å ç”¨ï¼š~250MBï¼ˆåªæœ‰æ—¶é—´æˆ³ï¼‰

ç¬¬äºŒéæ‰«æï¼š
â”œâ”€ åŠ è½½æ‰€æœ‰æ¶ˆæ¯æ•°æ®åˆ°ç¼“å†²åŒºï¼ˆâš ï¸ é—®é¢˜æ‰€åœ¨ï¼‰
â”‚  â”œâ”€ è¯»å–æ‰€æœ‰å›¾åƒæ•°æ®
â”‚  â”œâ”€ è¯»å–æ‰€æœ‰å…³èŠ‚çŠ¶æ€
â”‚  â””â”€ è¯»å–æ‰€æœ‰åŠ¨ä½œæ•°æ®
â”‚  å†…å­˜å ç”¨ï¼š~34GBï¼ˆå’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼ï¼‰
â”‚
â””â”€ æµå¼å¯¹é½å¤„ç†
    â”œâ”€ æŒ‰ä¸»æ—¶é—´æˆ³å¯¹é½
    â””â”€ è°ƒç”¨frame_callbackå¤„ç†
```

**å…³é”®ä»£ç **ï¼š
```python
# ç¬¬äºŒéæ‰«æï¼šåŠ è½½æ‰€æœ‰æ¶ˆæ¯åˆ°ç¼“å†²åŒº
for key, topic_info in self._topic_process_map.items():
    topic = topic_info["topic"]
    msg_process_fn = topic_info["msg_process_fn"]
    
    timestamps = []
    data_list = []
    
    # âš ï¸ åŠ è½½æ‰€æœ‰æ¶ˆæ¯æ•°æ®åˆ°å†…å­˜
    for _, msg, t in bag.read_messages(topics=topic):
        msg_data = msg_process_fn(msg)
        timestamp = t.to_sec()
        timestamps.append(timestamp)
        data_list.append(msg_data)  # âš ï¸ æ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­
    
    topic_timestamp_arrays[key] = np.array(timestamps)
    topic_data_buffers[key] = data_list  # âš ï¸ æ‰€æœ‰æ•°æ®éƒ½åœ¨ç¼“å†²åŒºä¸­
```

**å†…å­˜å ç”¨**ï¼š
- ç¬¬ä¸€éï¼š~250MBï¼ˆåªæœ‰æ—¶é—´æˆ³ï¼‰
- ç¬¬äºŒéï¼š~34GBï¼ˆæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼‰
- **æ€»å³°å€¼**ï¼š~34GBï¼ˆå’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç¬¬ä¸€éæ‰«æå†…å­˜å ç”¨å°
- âœ… å¯¹é½é€»è¾‘ç®€å•ï¼ˆæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ ç¬¬äºŒéæ‰«æä»ç„¶éœ€è¦åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
- âŒ å†…å­˜å³°å€¼å’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼ˆ~34GBï¼‰
- âŒ ä¸é€‚åˆè¶…å¤§rosbagæ–‡ä»¶

---

### 2. Chunked Streaming Method (`process_rosbag_chunked`) â­ **æ¨è**

**å®ç°ä½ç½®**ï¼š`kuavo_data/common/kuavo_dataset_chunked.py`

**å·¥ä½œæµç¨‹**ï¼š
```
ç¬¬ä¸€éæ‰«æï¼š
â”œâ”€ åªè¯»å–æ—¶é—´æˆ³ï¼ˆä¸åŠ è½½å›¾åƒæ•°æ®ï¼‰
â””â”€ ç¡®å®šä¸»æ—¶é—´çº¿å’Œæ—¶é—´æˆ³åºåˆ—
   å†…å­˜å ç”¨ï¼š~250MBï¼ˆåªæœ‰æ—¶é—´æˆ³ï¼‰

ç¬¬äºŒéæ‰«æï¼ˆåˆ†å—å¤„ç†ï¼‰ï¼š
â”œâ”€ å°†ä¸»æ—¶é—´æˆ³åˆ†æˆå¤šä¸ªchunkï¼ˆä¾‹å¦‚ï¼šchunk_size=100ï¼‰
â”‚
â”œâ”€ å¯¹äºæ¯ä¸ªchunkï¼š
â”‚  â”œâ”€ åªè¯»å–è¯¥chunkæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯ï¼ˆâœ… å…³é”®ä¼˜åŒ–ï¼‰
â”‚  â”œâ”€ å¯¹é½è¯¥chunkçš„å¸§
â”‚  â”œâ”€ è°ƒç”¨frame_callbackå¤„ç†
â”‚  â””â”€ ç«‹å³åˆ é™¤chunkæ•°æ®ï¼ˆâœ… å…³é”®ä¼˜åŒ–ï¼‰
â”‚  å†…å­˜å ç”¨ï¼š~200-500MBï¼ˆåªæœ‰å½“å‰chunkçš„æ•°æ®ï¼‰
â”‚
â””â”€ å¤„ç†å®Œæ‰€æœ‰chunk
   æ€»å³°å€¼ï¼š~500MBï¼ˆè¿œå°äºåŸå§‹æ–¹æ³•ï¼‰
```

**å…³é”®ä»£ç **ï¼š
```python
# ç¬¬äºŒéæ‰«æï¼šåˆ†å—å¤„ç†
for chunk_idx in range(num_chunks):
    # ç¡®å®šè¯¥chunkçš„æ—¶é—´èŒƒå›´
    chunk_start_time = chunk_timestamps[0] - time_margin
    chunk_end_time = chunk_timestamps[-1] + time_margin
    
    # âœ… åªè¯»å–è¯¥æ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
    chunk_data = self._read_chunk_data(bag, chunk_start_time, chunk_end_time)
    
    # å¯¹é½å¹¶å¤„ç†æ¯å¸§
    for main_stamp in chunk_timestamps:
        aligned_frame = self._align_single_frame(...)
        frame_callback(aligned_frame, frame_idx)
        # âœ… ç«‹å³åˆ é™¤aligned_frame
        del aligned_frame
    
    # âœ… ç«‹å³åˆ é™¤chunkæ•°æ®
    del chunk_data
```

**å†…å­˜å ç”¨**ï¼š
- ç¬¬ä¸€éï¼š~250MBï¼ˆåªæœ‰æ—¶é—´æˆ³ï¼‰
- ç¬¬äºŒéï¼š~200-500MBï¼ˆåªæœ‰å½“å‰chunkçš„æ•°æ®ï¼‰
- **æ€»å³°å€¼**ï¼š~500MBï¼ˆè¿œå°äºåŸå§‹æ–¹æ³•çš„34GBï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… çœŸæ­£å®ç°äº†åˆ†å—å¤„ç†
- âœ… å†…å­˜å ç”¨å¯æ§ï¼ˆ~500MB vs 34GBï¼‰
- âœ… é€‚åˆè¶…å¤§rosbagæ–‡ä»¶
- âœ… è¾¹è¯»è¾¹å¤„ç†è¾¹åˆ é™¤

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ä¸¤æ¬¡æ‰«ærosbagæ–‡ä»¶ï¼ˆä½†ç¬¬ä¸€éå¾ˆå¿«ï¼‰
- âš ï¸ å¯¹é½é€»è¾‘ç¨å¤æ‚ï¼ˆéœ€è¦å¤„ç†æ—¶é—´çª—å£ï¼‰

---

## ğŸ“Š è¯¦ç»†å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Streaming Method | Chunked Streaming Method |
|------|-----------------|------------------------|
| **ç¬¬ä¸€éæ‰«æ** | åªè¯»æ—¶é—´æˆ³ï¼ˆ~250MBï¼‰ | åªè¯»æ—¶é—´æˆ³ï¼ˆ~250MBï¼‰ |
| **ç¬¬äºŒéæ‰«æ** | åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆ~34GBï¼‰ | åˆ†å—åŠ è½½ï¼ˆ~200-500MBï¼‰ |
| **å†…å­˜å³°å€¼** | ~34GB | ~500MB |
| **å†…å­˜å‡å°‘** | 0%ï¼ˆå’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼‰ | 98.5%ï¼ˆä»34GBé™åˆ°500MBï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å°æ–‡ä»¶ï¼ˆ<5GBï¼‰ | å¤§æ–‡ä»¶ï¼ˆ>5GBï¼‰ |
| **å¤„ç†é€Ÿåº¦** | è¾ƒå¿«ï¼ˆæ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼‰ | ç¨æ…¢ï¼ˆéœ€è¦ä¸¤æ¬¡æ‰«æï¼‰ |
| **æ¨èåº¦** | âš ï¸ ä¸æ¨èï¼ˆå†…å­˜å ç”¨å¤§ï¼‰ | âœ… **å¼ºçƒˆæ¨è** |

---

## ğŸ¯ ä¸ºä»€ä¹ˆ Streaming Method å†…å­˜å ç”¨ä»ç„¶å¾ˆå¤§ï¼Ÿ

**é—®é¢˜æ ¹æº**ï¼š

è™½ç„¶å«"æµå¼å¤„ç†"ï¼Œä½† `StreamingRosbagProcessor.stream_process_rosbag()` åœ¨ç¬¬äºŒéæ‰«ææ—¶ï¼š

```python
# åŠ è½½æ‰€æœ‰æ¶ˆæ¯åˆ°ç¼“å†²åŒº
for key, topic_info in self._topic_process_map.items():
    topic = topic_info["topic"]
    msg_process_fn = topic_info["msg_process_fn"]
    
    data_list = []
    for _, msg, t in bag.read_messages(topics=topic):
        msg_data = msg_process_fn(msg)  # å¤„ç†æ¶ˆæ¯ï¼ˆè§£ç å›¾åƒç­‰ï¼‰
        data_list.append(msg_data)  # âš ï¸ æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨åˆ—è¡¨ä¸­
    
    topic_data_buffers[key] = data_list  # âš ï¸ æ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­
```

**é—®é¢˜**ï¼š
- æ‰€æœ‰æ¶ˆæ¯æ•°æ®éƒ½è¢«åŠ è½½åˆ° `topic_data_buffers` ä¸­
- è™½ç„¶å«"æµå¼"ï¼Œä½†å®é™…ä¸Šæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­
- å†…å­˜å ç”¨å’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼ˆ~34GBï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ**
- å¯¹é½é€»è¾‘éœ€è¦è®¿é—®æ‰€æœ‰æ—¶é—´æˆ³çš„æ•°æ®
- ä¸ºäº†æ‰¾åˆ°æœ€æ¥è¿‘çš„æ—¶é—´æˆ³ï¼Œéœ€è¦æ‰€æœ‰æ•°æ®åœ¨å†…å­˜ä¸­

---

## âœ… Chunked Streaming Method å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **åˆ†å—å¤„ç†**ï¼šå°†ä¸»æ—¶é—´æˆ³åˆ†æˆå¤šä¸ªchunk
2. **æŒ‰æ—¶é—´çª—å£è¯»å–**ï¼šæ¯ä¸ªchunkåªè¯»å–è¯¥æ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
3. **ç«‹å³åˆ é™¤**ï¼šå¤„ç†å®Œchunkåç«‹å³åˆ é™¤æ•°æ®

```python
# åªè¯»å–chunkæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
chunk_data = self._read_chunk_data(bag, chunk_start_time, chunk_end_time)

# å¤„ç†å®Œchunkåç«‹å³åˆ é™¤
del chunk_data
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ªchunkåªä¿ç•™å¿…è¦çš„æ•°æ®ï¼ˆ~200-500MBï¼‰
- âœ… å¤„ç†å®Œç«‹å³åˆ é™¤ï¼Œå†…å­˜ä¸ä¼šç´¯ç§¯
- âœ… çœŸæ­£å®ç°äº†æµå¼å¤„ç†

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ¨èä½¿ç”¨ï¼šChunked Streaming Method

```python
# âœ… æ¨èï¼šä½¿ç”¨åˆ†å—æµå¼æ–¹æ³•
bag_reader.process_rosbag_chunked(
    bag_file=bag_file,
    frame_callback=on_frame,
    chunk_size=100,  # æ¯ä¸ªchunk 100å¸§
    save_callback=on_chunk_done
)
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¤§æ–‡ä»¶ï¼ˆ>5GBï¼‰
- âœ… å†…å­˜å—é™çš„ç¯å¢ƒ
- âœ… éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„å¤„ç†ä»»åŠ¡

### ä¸æ¨èä½¿ç”¨ï¼šStreaming Method

```python
# âš ï¸ ä¸æ¨èï¼šå†…å­˜å ç”¨ä»ç„¶å¾ˆå¤§
bag_reader.process_rosbag_streaming(
    bag_file=bag_file,
    frame_callback=on_frame,
    chunk_size=None
)
```

**é—®é¢˜**ï¼š
- âŒ å†…å­˜å ç”¨å’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼ˆ~34GBï¼‰
- âŒ ä¸é€‚åˆå¤§æ–‡ä»¶
- âŒ å¯èƒ½OOM

---

## ğŸ“ æ€»ç»“

### Streaming Method
- **åç§°**ï¼šæµå¼å¤„ç†
- **å®é™…**ï¼šç¬¬äºŒéæ‰«æä»ç„¶åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
- **å†…å­˜**ï¼š~34GBï¼ˆå’ŒåŸå§‹æ–¹æ³•ä¸€æ ·ï¼‰
- **æ¨èåº¦**ï¼šâš ï¸ ä¸æ¨è

### Chunked Streaming Method â­
- **åç§°**ï¼šåˆ†å—æµå¼å¤„ç†
- **å®é™…**ï¼šçœŸæ­£å®ç°äº†åˆ†å—å¤„ç†ï¼Œè¾¹è¯»è¾¹å¤„ç†è¾¹åˆ é™¤
- **å†…å­˜**ï¼š~500MBï¼ˆè¿œå°äºåŸå§‹æ–¹æ³•ï¼‰
- **æ¨èåº¦**ï¼šâœ… **å¼ºçƒˆæ¨è**

---

**ç›¸å…³æ–‡ä»¶**ï¼š
- `kuavo_data/common/kuavo_dataset_streaming.py` - Streaming Methodå®ç°
- `kuavo_data/common/kuavo_dataset_chunked.py` - Chunked Streaming Methodå®ç°
- `kuavo_data/test_rosbag_conversion.py` - æµ‹è¯•è„šæœ¬


