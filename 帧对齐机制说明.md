# å¸§å¯¹é½æœºåˆ¶è¯´æ˜ (Frame Alignment Mechanism)

## ğŸ“ ä»£ç ä½ç½®

å¸§å¯¹é½çš„æ ¸å¿ƒä»£ç ä½äºä»¥ä¸‹æ–‡ä»¶ï¼š

1. **æ ¸å¿ƒå¯¹é½ç®—æ³•**ï¼š`diffusion_policy/common/timestamp_accumulator.py`
   - `get_accumulate_timestamp_idxs()` - æ—¶é—´æˆ³ç´¢å¼•è®¡ç®—å‡½æ•°
   - `align_timestamps()` - æ—¶é—´æˆ³å¯¹é½å‡½æ•°
   - `TimestampObsAccumulator` - è§‚å¯Ÿæ•°æ®æ—¶é—´æˆ³ç´¯åŠ å™¨
   - `TimestampActionAccumulator` - åŠ¨ä½œæ•°æ®æ—¶é—´æˆ³ç´¯åŠ å™¨

2. **å®é™…åº”ç”¨**ï¼š`diffusion_policy/real_world/real_env.py`
   - `RealEnv.get_obs()` æ–¹æ³•ä¸­ä½¿ç”¨å¸§å¯¹é½ï¼ˆç¬¬243-307è¡Œï¼‰

3. **å…¶ä»–ä½¿ç”¨ä½ç½®**ï¼š
   - `diffusion_policy/real_world/single_realsense.py` - ç›¸æœºæ•°æ®çš„æ—¶é—´æˆ³å¯¹é½
   - `diffusion_policy/real_world/video_recorder.py` - è§†é¢‘å½•åˆ¶æ—¶çš„æ—¶é—´æˆ³å¯¹é½

## ğŸ”§ å¸§å¯¹é½æ–¹å¼

### å¯¹é½æ–¹æ³•ï¼š**åŸºäºæ—¶é—´æˆ³çš„æœ€è¿‘é‚»æŸ¥æ‰¾ï¼ˆTimestamp-based Nearest Neighbor Lookupï¼‰**

è¿™æ˜¯ä¸€ç§**éå‡åŒ€é‡‡æ ·å¯¹é½**æ–¹æ³•ï¼Œç”¨äºå°†ä¸åŒé¢‘ç‡çš„æ•°æ®æµå¯¹é½åˆ°ç»Ÿä¸€çš„æ—¶é—´ç½‘æ ¼ä¸Šã€‚

### æ ¸å¿ƒç®—æ³•æµç¨‹

#### 1. åœ¨ `real_env.py` ä¸­çš„å®ç°

```258:307:diffusion_policy/real_world/real_env.py
        # align camera obs timestamps
        dt = 1 / self.frequency
        last_timestamp = np.max([x['timestamp'][-1] for x in self.last_realsense_data.values()])
        obs_align_timestamps = last_timestamp - (np.arange(self.n_obs_steps)[::-1] * dt)

        camera_obs = dict()
        for camera_idx, value in self.last_realsense_data.items():
            this_timestamps = value['timestamp']
            this_idxs = list()
            for t in obs_align_timestamps:
                is_before_idxs = np.nonzero(this_timestamps < t)[0]
                this_idx = 0
                if len(is_before_idxs) > 0:
                    this_idx = is_before_idxs[-1]
                this_idxs.append(this_idx)
            # remap key
            camera_obs[f'camera_{camera_idx}'] = value['color'][this_idxs]

        # align robot obs
        robot_timestamps = last_robot_data['robot_receive_timestamp']
        this_timestamps = robot_timestamps
        this_idxs = list()
        for t in obs_align_timestamps:
            is_before_idxs = np.nonzero(this_timestamps < t)[0]
            this_idx = 0
            if len(is_before_idxs) > 0:
                this_idx = is_before_idxs[-1]
            this_idxs.append(this_idx)

        robot_obs_raw = dict()
        for k, v in last_robot_data.items():
            if k in self.obs_key_map:
                robot_obs_raw[self.obs_key_map[k]] = v
        
        robot_obs = dict()
        for k, v in robot_obs_raw.items():
            robot_obs[k] = v[this_idxs]

        # accumulate obs
        if self.obs_accumulator is not None:
            self.obs_accumulator.put(
                robot_obs_raw,
                robot_timestamps
            )

        # return obs
        obs_data = dict(camera_obs)
        obs_data.update(robot_obs)
        obs_data['timestamp'] = obs_align_timestamps
        return obs_data
```

#### 2. å¯¹é½æ­¥éª¤è¯¦è§£

**æ­¥éª¤ 1ï¼šç”Ÿæˆç›®æ ‡æ—¶é—´æˆ³åºåˆ—**
```python
# è®¡ç®—æ§åˆ¶é¢‘ç‡çš„æ—¶é—´é—´éš”
dt = 1 / self.frequency  # ä¾‹å¦‚ï¼š1/10 = 0.1ç§’

# æ‰¾åˆ°æ‰€æœ‰ç›¸æœºæ•°æ®ä¸­æœ€æ–°çš„æ—¶é—´æˆ³
last_timestamp = np.max([x['timestamp'][-1] for x in self.last_realsense_data.values()])

# ç”Ÿæˆå¯¹é½çš„ç›®æ ‡æ—¶é—´æˆ³åºåˆ—ï¼ˆå‘åå›æº¯ n_obs_steps æ­¥ï¼‰
# ä¾‹å¦‚ï¼šn_obs_steps=2, dt=0.1
# obs_align_timestamps = [last_timestamp - 0.1, last_timestamp]
obs_align_timestamps = last_timestamp - (np.arange(self.n_obs_steps)[::-1] * dt)
```

**æ­¥éª¤ 2ï¼šä¸ºæ¯ä¸ªç›®æ ‡æ—¶é—´æˆ³æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¸§ï¼ˆæœ€è¿‘é‚»æŸ¥æ‰¾ï¼‰**
```python
for t in obs_align_timestamps:
    # æ‰¾åˆ°æ‰€æœ‰å°äºç›®æ ‡æ—¶é—´æˆ³çš„ç´¢å¼•
    is_before_idxs = np.nonzero(this_timestamps < t)[0]
    
    # é€‰æ‹©æœ€åä¸€ä¸ªï¼ˆæœ€æ¥è¿‘ä½†ä¸è¶…è¿‡ç›®æ ‡æ—¶é—´æˆ³çš„å¸§ï¼‰
    this_idx = 0
    if len(is_before_idxs) > 0:
        this_idx = is_before_idxs[-1]  # æœ€è¿‘é‚»ï¼ˆå‘åæŸ¥æ‰¾ï¼‰
    
    this_idxs.append(this_idx)
```

**å¯¹é½ç­–ç•¥**ï¼š
- **æœ€è¿‘é‚»å‘åæŸ¥æ‰¾**ï¼šå¯¹äºæ¯ä¸ªç›®æ ‡æ—¶é—´æˆ³ `t`ï¼Œé€‰æ‹©å®é™…æ—¶é—´æˆ³ä¸­**å°äºç­‰äº `t` çš„æœ€å¤§å€¼**å¯¹åº”çš„å¸§
- è¿™ç¡®ä¿äº†ä½¿ç”¨çš„æ•°æ®æ˜¯"è¿‡å»"çš„æ•°æ®ï¼Œä¸ä¼šä½¿ç”¨"æœªæ¥"çš„æ•°æ®

#### 3. æ ¸å¿ƒå¯¹é½å‡½æ•°ï¼š`get_accumulate_timestamp_idxs()`

```6:41:diffusion_policy/common/timestamp_accumulator.py
def get_accumulate_timestamp_idxs(
    timestamps: List[float],  
    start_time: float, 
    dt: float, 
    eps:float=1e-5,
    next_global_idx: Optional[int]=0,
    allow_negative=False
    ) -> Tuple[List[int], List[int], int]:
    """
    For each dt window, choose the first timestamp in the window.
    Assumes timestamps sorted. One timestamp might be chosen multiple times due to dropped frames.
    next_global_idx should start at 0 normally, and then use the returned next_global_idx. 
    However, when overwiting previous values are desired, set last_global_idx to None.

    Returns:
    local_idxs: which index in the given timestamps array to chose from
    global_idxs: the global index of each chosen timestamp
    next_global_idx: used for next call.
    """
    local_idxs = list()
    global_idxs = list()
    for local_idx, ts in enumerate(timestamps):
        # add eps * dt to timestamps so that when ts == start_time + k * dt 
        # is always recorded as kth element (avoiding floating point errors)
        global_idx = math.floor((ts - start_time) / dt + eps)
        if (not allow_negative) and (global_idx < 0):
            continue
        if next_global_idx is None:
            next_global_idx = global_idx

        n_repeats = max(0, global_idx - next_global_idx + 1)
        for i in range(n_repeats):
            local_idxs.append(local_idx)
            global_idxs.append(next_global_idx + i)
        next_global_idx += n_repeats
    return local_idxs, global_idxs, next_global_idx
```

**å‡½æ•°åŠŸèƒ½**ï¼š
- å°†éå‡åŒ€æ—¶é—´æˆ³æ˜ å°„åˆ°å‡åŒ€çš„æ—¶é—´ç½‘æ ¼ä¸Š
- ä½¿ç”¨ `math.floor((ts - start_time) / dt + eps)` è®¡ç®—æ¯ä¸ªæ—¶é—´æˆ³å±äºå“ªä¸ªæ—¶é—´çª—å£
- å¤„ç†ä¸¢å¸§æƒ…å†µï¼šä¸€ä¸ªæ—¶é—´æˆ³å¯èƒ½è¢«é€‰æ‹©å¤šæ¬¡ï¼ˆé‡å¤ä½¿ç”¨ï¼‰

## ğŸ“Š å¯¹é½åœºæ™¯

### åœºæ™¯ 1ï¼šå¤šé¢‘ç‡æ•°æ®æºå¯¹é½

åœ¨ `real_env.py` ä¸­ï¼Œéœ€è¦å¯¹é½çš„æ•°æ®æºï¼š

| æ•°æ®æº | é¢‘ç‡ | æ—¶é—´æˆ³å­—æ®µ |
|--------|------|-----------|
| RealSense ç›¸æœº | 30 Hz | `camera_receive_timestamp` |
| UR5 æœºå™¨äºº | 125 Hz | `robot_receive_timestamp` |
| æ§åˆ¶é¢‘ç‡ | 10 Hz | ç›®æ ‡å¯¹é½é¢‘ç‡ |

**å¯¹é½è¿‡ç¨‹**ï¼š
1. ç›¸æœºæ•°æ®ï¼š30 Hz â†’ å¯¹é½åˆ° 10 Hz ç½‘æ ¼
2. æœºå™¨äººæ•°æ®ï¼š125 Hz â†’ å¯¹é½åˆ° 10 Hz ç½‘æ ¼
3. ç”Ÿæˆç»Ÿä¸€çš„è§‚å¯Ÿåºåˆ—ï¼š`n_obs_steps` ä¸ªæ—¶é—´æ­¥

### åœºæ™¯ 2ï¼šæ—¶é—´æˆ³å¯¹é½ç¤ºä¾‹

å‡è®¾ï¼š
- `n_obs_steps = 2`
- `frequency = 10 Hz` (dt = 0.1ç§’)
- ç›¸æœºæœ€æ–°æ—¶é—´æˆ³ï¼š`t_last = 100.5ç§’`

**ç”Ÿæˆç›®æ ‡æ—¶é—´æˆ³**ï¼š
```python
obs_align_timestamps = [100.4, 100.5]  # å‘åå›æº¯2æ­¥
```

**å¯¹é½è¿‡ç¨‹**ï¼š
```python
# ç›¸æœºæ—¶é—´æˆ³åºåˆ—ï¼ˆ30Hzï¼Œçº¦0.033ç§’é—´éš”ï¼‰
camera_timestamps = [100.33, 100.36, 100.40, 100.43, 100.47, 100.50]

# å¯¹é½åˆ°ç›®æ ‡æ—¶é—´æˆ³
# t=100.4: é€‰æ‹© <= 100.4 çš„æœ€å¤§å€¼ â†’ 100.40 (ç´¢å¼•2)
# t=100.5: é€‰æ‹© <= 100.5 çš„æœ€å¤§å€¼ â†’ 100.50 (ç´¢å¼•5)
camera_idxs = [2, 5]
```

## ğŸ” å¯¹é½æ–¹å¼ç‰¹ç‚¹

### ä¼˜ç‚¹

1. **å¤„ç†éå‡åŒ€é‡‡æ ·**ï¼šèƒ½å¤Ÿå¤„ç†ä¸åŒé¢‘ç‡çš„æ•°æ®æº
2. **å¤„ç†ä¸¢å¸§**ï¼šé€šè¿‡é‡å¤ä½¿ç”¨æœ€è¿‘å¸§å¤„ç†ä¸¢å¸§æƒ…å†µ
3. **æ—¶é—´ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰æ•°æ®æºå¯¹é½åˆ°åŒä¸€æ—¶é—´ç½‘æ ¼
4. **å‘åå…¼å®¹**ï¼šåªä½¿ç”¨"è¿‡å»"çš„æ•°æ®ï¼Œä¸é¢„æµ‹æœªæ¥

### å±€é™æ€§

1. **æ—¶é—´å»¶è¿Ÿ**ï¼šä½¿ç”¨æœ€è¿‘é‚»å¯èƒ½å¼•å…¥å°çš„æ—¶é—´å»¶è¿Ÿ
2. **ä¸¢å¸§å¤„ç†**ï¼šä¸¢å¸§æ—¶ä¼šé‡å¤ä½¿ç”¨å‰ä¸€å¸§ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸æ–°é²œ
3. **è®¡ç®—å¼€é”€**ï¼šéœ€è¦å¯¹æ¯ä¸ªç›®æ ‡æ—¶é—´æˆ³è¿›è¡ŒæŸ¥æ‰¾æ“ä½œ

## ğŸ“ å…³é”®å˜é‡è¯´æ˜

- `dt`: æ§åˆ¶é¢‘ç‡çš„æ—¶é—´é—´éš”ï¼ˆ1/frequencyï¼‰
- `n_obs_steps`: è§‚å¯Ÿåºåˆ—çš„é•¿åº¦ï¼ˆéœ€è¦å¯¹é½çš„å¸§æ•°ï¼‰
- `obs_align_timestamps`: ç›®æ ‡å¯¹é½æ—¶é—´æˆ³åºåˆ—
- `this_timestamps`: å®é™…æ•°æ®çš„æ—¶é—´æˆ³æ•°ç»„
- `this_idxs`: å¯¹é½åé€‰æ‹©çš„ç´¢å¼•æ•°ç»„
- `eps`: æµ®ç‚¹æ•°ç²¾åº¦å®¹å·®ï¼ˆé¿å…æµ®ç‚¹è¯¯å·®ï¼‰

## ğŸ¯ ä½¿ç”¨åœºæ™¯

1. **å®æ—¶æœºå™¨äººæ§åˆ¶**ï¼šå°†ä¸åŒé¢‘ç‡çš„ä¼ æ„Ÿå™¨æ•°æ®å¯¹é½åˆ°æ§åˆ¶é¢‘ç‡
2. **æ•°æ®å½•åˆ¶**ï¼šå½•åˆ¶æ—¶å¯¹é½å¤šè·¯æ•°æ®æµ
3. **è§†é¢‘å¤„ç†**ï¼šå¯¹é½è§†é¢‘å¸§åˆ°å›ºå®šæ—¶é—´ç½‘æ ¼

## ğŸ“š ç›¸å…³å‡½æ•°

- `get_accumulate_timestamp_idxs()`: å°†æ—¶é—´æˆ³æ˜ å°„åˆ°æ—¶é—´ç½‘æ ¼ç´¢å¼•
- `align_timestamps()`: å°†æ—¶é—´æˆ³å¯¹é½åˆ°ç›®æ ‡å…¨å±€ç´¢å¼•
- `TimestampObsAccumulator.put()`: ç´¯ç§¯è§‚å¯Ÿæ•°æ®å¹¶è‡ªåŠ¨å¯¹é½
- `TimestampActionAccumulator.put()`: ç´¯ç§¯åŠ¨ä½œæ•°æ®å¹¶è‡ªåŠ¨å¯¹é½


